name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Fix gradle-wrapper.jar if missing or corrupt
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„ä¸å­˜åœ¨æˆ–å·²æŸå
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ] || ! jar tf gradle/wrapper/gradle-wrapper.jar > /dev/null 2>&1; then
            echo "gradle-wrapper.jar is missing or invalid. Attempting to fix..."

            # 1. è¯»å–Gradleç‰ˆæœ¬
            VERSION=$(grep 'distributionUrl' gradle/wrapper/gradle-wrapper.properties | sed -n 's|.*gradle-\([0-9.]*\)-.*|\1|p')
            if [ -z "$VERSION" ]; then
              echo "âŒ Could not determine Gradle version from gradle-wrapper.properties"
              exit 1
            fi
            echo "ğŸ“¦ Detected Gradle version: $VERSION"

            # 2. ç¡®å®šåˆ†å‘ç±»å‹ (bin æˆ– all)
            if grep -q "-all.zip" gradle/wrapper/gradle-wrapper.properties; then
              DIST_TYPE="all"
              DIST_URL="https://services.gradle.org/distributions/gradle-${VERSION}-all.zip"
            else
              DIST_TYPE="bin"
              DIST_URL="https://services.gradle.org/distributions/gradle-${VERSION}-bin.zip"
            fi
            echo "ğŸ”— Distribution type: $DIST_TYPE"

            # 3. ä¸‹è½½åˆ†å‘ZIPåŒ…
            echo "ğŸ“¥ Downloading Gradle distribution from: $DIST_URL"
            wget -q "$DIST_URL" -O "gradle-dist.zip"

            # 4. æ£€æŸ¥ZIPåŒ…å†…æ˜¯å¦å­˜åœ¨é¢„æœŸçš„wrapper jaræ–‡ä»¶
            # åˆ—å‡ºZIPåŒ…å†…å®¹ï¼Œå¯»æ‰¾å¯èƒ½çš„wrapper jarè·¯å¾„
            echo "ğŸ” Searching for gradle-wrapper.jar in the distribution..."
            UNZIP_PATHS=$(unzip -l "gradle-dist.zip" | grep "gradle-wrapper.jar" | awk '{print $4}' | head -1)

            if [ -z "$UNZIP_PATHS" ]; then
              echo "âŒ gradle-wrapper.jar not found in the distribution zip."
              echo "This distribution type ($DIST_TYPE) might not contain it. Trying to generate it using gradle command..."

              # å°è¯•ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„gradleç”Ÿæˆwrapper
              if command -v gradle > /dev/null 2>&1; then
                gradle wrapper --gradle-version $VERSION
                echo "âœ… Gradle wrapper regenerated using system gradle."
              else
                echo "âŒ System gradle not available. Cannot generate wrapper."
                echo "ğŸ’¡ Consider committing the correct gradle-wrapper.jar to your repository."
                exit 1
              fi
            else
              echo "âœ… Found gradle-wrapper.jar at: $UNZIP_PATHS"
              # è§£å‹ç‰¹å®šçš„æ–‡ä»¶
              unzip -q -o "gradle-dist.zip" "$UNZIP_PATHS" -d "temp-gradle/"
              # å°†æ–‡ä»¶ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®
              mv "temp-gradle/$UNZIP_PATHS" "gradle/wrapper/gradle-wrapper.jar"
              rm -rf "temp-gradle"
              echo "âœ… gradle-wrapper.jar extracted and placed correctly."
            fi

            # æ¸…ç†
            rm -f "gradle-dist.zip"
          else
            echo "âœ… gradle-wrapper.jar exists and appears valid."
          fi

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Find all APKs
        run: find . -type f -name "*.apk"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: '**/*.apk'
