name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Fix gradle wrapper (simple version)
        run: |
          # 如果wrapper jar文件不存在或损坏
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ] || ! jar tf gradle/wrapper/gradle-wrapper.jar >/dev/null 2>&1; then
            echo "修复 gradle-wrapper.jar..."
            
            # 方法1：使用系统gradle重新生成
            if command -v gradle >/dev/null 2>&1; then
              # 读取项目中配置的gradle版本
              VERSION=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | sed 's|.*gradle-||;s|-.*||')
              echo "使用系统gradle重新生成wrapper，版本: $VERSION"
              gradle wrapper --gradle-version $VERSION
            else
              # 方法2：如果系统没有gradle，下载指定版本的完整gradle
              echo "下载Gradle..."
              VERSION=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | sed 's|.*gradle-||;s|-.*||')
              wget https://services.gradle.org/distributions/gradle-$VERSION-all.zip
              unzip gradle-$VERSION-all.zip
              # 使用下载的gradle重新生成wrapper
              gradle-$VERSION/bin/gradle wrapper
              rm -rf gradle-$VERSION*
            fi
            echo "修复完成"
          else
            echo "gradle-wrapper.jar 正常"
          fi

      - name: Build with Gradle
        run: |
          ./gradlew assembleDebug
          
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
